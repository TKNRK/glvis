# KW4: クリックされた頂点の識別

## このコードの目的

画面に描かれた頂点をクリックしたときに，クリックされた頂点を識別すること．

## 利用している技術

- Shader Storage Buffer (SSB)

- Ctypes (FFI)

- flatシェーダー変数

- 原子的更新

## 実装方式

1. シェーダ領域バッファ(Shader Storage Buffer: SSB)の準備 (`initializeGL`メソッド)

    1. SSBを作成する．

1. アプリケーション：クリックの検知の準備

    1. `MouseReleaseEvent`からクリックされた座標を取得し，GPUの`clickedPosition`Uniform変数に設定する．

    1. `should_handle_mouse_click`フラグをTrueに設定する．このフラグは，次の描画サイクル終了時にSSBからGPU側が保存した情報を取得することを指示している．

1. 頂点シェーダ：頂点IDを画素シェーダに伝達

    画素シェーダ変数`vertexID_fs`を利用して頂点IDを保存する．この変数は，`flat`宣言することにより，この頂点が関与するすべての画素シェーダに共有される．

1. 画素シェーダ：クリック場所の検知

    画素の座標とクリックされた座標を比較し，一致していたらシェーダ共有バッファ(SSB)に頂点IDを保存する．ただし，複数の頂点が重なっている場合には，手前に表示された頂点のIDを保存しなくてはならない．さらに，この処理は画素ごとの並列性を考慮して原子的に行う．

    1. 画素の座標がクリックされた座標を比較する．このとき，OpenGLにおいて画素の座標がfloat値で(x + 0.5, y + 0.5)をとることに注意する．実装においては`int`にキャストしてから比較している．以前の版では`distance < 1`のような計算を用いていたが，現在の版の方が効率的．

    1. 座標が一致した場合は，保存すべき頂点IDの候補ということになるが，もっと手前に別の頂点が存在する可能性に配慮しなくてはいけない．そこで，SSBに頂点IDを保存するための`pick_id`とその頂点のモデルビュー空間におけるZ座標を保存するための`pick_z`を用意し，両者を原始的に更新する．原子性を実現する施錠のために`pick_lock`も利用している．これらの更新は以下のとおり．

        1. `atomicCompSwap(pick_lock, Unlocked, Locked)`により，鍵の取得を試みる．

        1. 鍵が取得できたら，頂点ID(`pick_id`)と頂点のZ座標(`pick_z`)を保存し，鍵を開放する(`pick_lock = Unlock`)．

        この更新処理を`while`ループのなかで実施することで，重なって表示されている異なる頂点による並列的な代入があったときも最終的には最も手前の頂点のIDが保存される．

1. アプリケーション：検知されたクリック箇所の取得 (`handleMouseClick`)

    この時点でクリックされた頂点のIDはSSBに保存されているので，SSBをアプリケーション側にマップし，その構造から頂点IDを取得すればよい．

    1. `glMapBuffer`により，SSBをアプリケーション側にマップする．OpenGLの`glMapBuffer`は，マップされたメモリ領域へのポインタを返すが，それをPythonから直接参照することはできない．

    1. マップされた領域をctypes（Pythonの外部関数インターフェース）の構造体にキャストし，フィールドを参照．

    1. `glUnmapBuffer`でSSBへのポインタを開放．

## はまりました (2016.6.23)

クリックに反応しなくなった。

- シェーダーで `if (gl_Fragcoord.x < clicked_x) discard;` を挿入した。本来ならば、クリックした箇所より左が消えるはずだが、効果はなかった。つまり、`mouseReleaseEvent`メソッドで保存したクリック場所の情報が正しくSSBに保存されていない。

- 次に、`initializeGL`で`ssb = SSB()`によりSSBのアプリケーション側のメモリ領域を確保したのちに`ssb.clicked_x = 200;`などとしたところ、今度は画面の左の部分が消えた。ということは`initializeGL`のところでの設定はGPU側のシェーダに伝わっているらしい。これはよいニュース。

- 今は、Superbibleを読みなおしている。
