# KW4: クリックされた頂点の識別

## このコードの目的

画面に描かれた頂点をクリックしたときに，クリックされた頂点を識別すること．

## 利用している技術

- Shader Storage Buffer (SSB)

- Ctypes (FFI)

- flatシェーダー変数

## 実装方式

1. シェーダ領域バッファ(Shader Storage Buffer: SSB)の準備 (`initializeGL`メソッド)

    1. SSBを作成する．

1. アプリケーション：クリックの検知の準備

    1. `MouseReleaseEvent`からクリックされた座標を取得し，GPUの`clickedPosition`Uniform変数に設定する．

    1. `should_handle_mouse_click`フラグをTrueに設定する．このフラグは，次の描画サイクル終了時にSSBからGPU側が保存した情報を取得することを指示している．

1. 頂点シェーダ：頂点IDを画素シェーダに伝達

    画素シェーダ変数`vertexID_fs`を利用して頂点IDを保存する．この変数は，`flat`宣言することにより，この頂点が関与するすべての画素シェーダに共有される．

1. 画素シェーダ：クリック場所の検知

    画素の座標とクリックされた座標を比較し，一致していたらシェーダ共有バッファ(SSB)に頂点IDを保存する．

1. アプリケーション：検知されたクリック箇所の取得 (`handleMouseClick`)

    この時点でクリックされた頂点のIDはSSBに保存されているので，SSBをアプリケーション側にマップし，その構造から頂点IDを取得すればよい．

    1. `glMapBuffer`により，SSBをアプリケーション側にマップする．OpenGLの`glMapBuffer`は，マップされたメモリ領域へのポインタを返すが，それをPythonから直接参照することはできない．

    1. マップされた領域をctypes（Pythonの外部関数インターフェース）の構造体にキャストし，フィールドを参照．

    1. `glUnmapBuffer`でSSBへのポインタを開放．
